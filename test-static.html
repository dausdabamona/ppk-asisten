<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>PPK Pegawai API Test</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .success { color: green; background: #e8f5e9; padding: 10px; margin: 10px 0; }
    .error { color: red; background: #ffebee; padding: 10px; margin: 10px 0; }
    .info { color: blue; background: #e3f2fd; padding: 10px; margin: 10px 0; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #f5f5f5; }
    button { padding: 10px 20px; margin: 5px; cursor: pointer; }
  </style>
</head>
<body>
  <h1>üîß PPK Pegawai API Diagnostic Test</h1>
  
  <div id="diagnostics"></div>
  <div id="result"></div>
  <div id="pegawaiList"></div>
  
  <button onclick="testElectronAPI()">Test electronAPI</button>
  <button onclick="testPegawaiAPI()">Test Pegawai API</button>
  <button onclick="listAllPegawai()">List All Pegawai</button>
  <button onclick="location.reload()">Reload Page</button>
  
  <script>
    const resultsDiv = document.getElementById('result');
    const diagnosticsDiv = document.getElementById('diagnostics');
    const pegawaiListDiv = document.getElementById('pegawaiList');
    
    // Run diagnostics on load
    window.addEventListener('DOMContentLoaded', () => {
      runDiagnostics();
    });
    
    function addLog(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
      const div = document.createElement('div');
      div.className = className;
      div.textContent = `[${timestamp}] ${message}`;
      resultsDiv.appendChild(div);
      console.log(`[${type.toUpperCase()}] ${message}`);
    }
    
    function runDiagnostics() {
      const diag = document.createElement('div');
      diag.innerHTML = '<h2>üîç Diagnostics</h2>';
      
      // Check 1: electronAPI
      if (typeof window.electronAPI !== 'undefined') {
        diag.innerHTML += '<p class="success">‚úÖ window.electronAPI exists</p>';
      } else {
        diag.innerHTML += '<p class="error">‚ùå window.electronAPI is undefined</p>';
      }
      
      // Check 2: pegawai API
      if (window.electronAPI && typeof window.electronAPI.pegawai !== 'undefined') {
        diag.innerHTML += '<p class="success">‚úÖ window.electronAPI.pegawai exists</p>';
        
        // Check methods
        const methods = ['list', 'get', 'create', 'update', 'delete', 'search'];
        methods.forEach(method => {
          if (typeof window.electronAPI.pegawai[method] === 'function') {
            diag.innerHTML += `<p class="success">  ‚úÖ pegawai.${method}() available</p>`;
          } else {
            diag.innerHTML += `<p class="error">  ‚ùå pegawai.${method}() NOT available</p>`;
          }
        });
      } else {
        diag.innerHTML += '<p class="error">‚ùå window.electronAPI.pegawai is undefined</p>';
      }
      
      diagnosticsDiv.innerHTML = diag.innerHTML;
    }
    
    async function testElectronAPI() {
      addLog('Testing electronAPI...', 'info');
      
      if (!window.electronAPI) {
        addLog('‚ùå electronAPI is undefined!', 'error');
        return;
      }
      
      addLog('‚úÖ electronAPI is defined', 'success');
      addLog('Available keys: ' + Object.keys(window.electronAPI).join(', '), 'info');
      
      // Try to call app.getVersion if available
      if (window.electronAPI.app && window.electronAPI.app.getVersion) {
        try {
          const version = await window.electronAPI.app.getVersion();
          addLog('‚úÖ App version: ' + version, 'success');
        } catch (err) {
          addLog('Error getting version: ' + err.message, 'error');
        }
      }
    }
    
    async function testPegawaiAPI() {
      addLog('Testing Pegawai API...', 'info');
      
      if (!window.electronAPI || !window.electronAPI.pegawai) {
        addLog('‚ùå Pegawai API not available', 'error');
        return;
      }
      
      addLog('‚úÖ Pegawai API is available', 'success');
      addLog('Methods: ' + Object.keys(window.electronAPI.pegawai).join(', '), 'info');
      
      // Try to list pegawai
      try {
        addLog('Calling pegawai.list()...', 'info');
        const result = await window.electronAPI.pegawai.list({ limit: 5 });
        
        if (result.success) {
          addLog(`‚úÖ Pegawai list retrieved: ${result.total} total, ${result.data.length} returned`, 'success');
          displayPegawaiTable(result.data);
        } else {
          addLog(`‚ùå API error: ${result.error || 'Unknown error'}`, 'error');
        }
      } catch (err) {
        addLog(`‚ùå Exception calling pegawai.list(): ${err.message}`, 'error');
        console.error('Full error:', err);
      }
    }
    
    async function listAllPegawai() {
      addLog('Loading all pegawai...', 'info');
      
      try {
        const result = await window.electronAPI.pegawai.list({ limit: 1000 });
        if (result.success) {
          addLog(`‚úÖ Loaded ${result.data.length} pegawai from database`, 'success');
          displayPegawaiTable(result.data);
        }
      } catch (err) {
        addLog(`‚ùå Error: ${err.message}`, 'error');
      }
    }
    
    function displayPegawaiTable(pegawaiData) {
      if (!pegawaiData || pegawaiData.length === 0) {
        pegawaiListDiv.innerHTML = '<p class="error">No pegawai data to display</p>';
        return;
      }
      
      let html = `<h3>üìã Pegawai List (${pegawaiData.length} records)</h3>`;
      html += '<table>';
      html += '<tr><th>NIP</th><th>Nama</th><th>Pangkat</th><th>Jabatan</th></tr>';
      
      pegawaiData.forEach(p => {
        html += `<tr>
          <td>${p.nip || '-'}</td>
          <td>${p.nama || '-'}</td>
          <td>${p.pangkat || '-'}</td>
          <td>${p.jabatan || '-'}</td>
        </tr>`;
      });
      
      html += '</table>';
      pegawaiListDiv.innerHTML = html;
    }
  </script>
</body>
</html>
