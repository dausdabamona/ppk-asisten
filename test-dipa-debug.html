<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>PPK DIPA API Test - HTTP Fallback</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
    .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
    .success { color: green; background: #e8f5e9; padding: 10px; margin: 10px 0; border-radius: 4px; }
    .error { color: red; background: #ffebee; padding: 10px; margin: 10px 0; border-radius: 4px; }
    .warning { color: orange; background: #fff3e0; padding: 10px; margin: 10px 0; border-radius: 4px; }
    .info { color: blue; background: #e3f2fd; padding: 10px; margin: 10px 0; border-radius: 4px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
    th { background-color: #2196F3; color: white; }
    tr:nth-child(even) { background-color: #f9f9f9; }
    button { padding: 10px 20px; margin: 5px; cursor: pointer; background: #2196F3; color: white; border: none; border-radius: 4px; }
    button:hover { background: #1976D2; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    h2 { color: #333; border-bottom: 2px solid #2196F3; padding-bottom: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîß PPK DIPA API Diagnostic Test</h1>
    <p><em>Testing with fallback to Node.js direct API calls</em></p>
    
    <div id="diagnostics"></div>
    <div id="result"></div>
    <div id="dipaList"></div>
    
    <h2>üß™ Test Controls</h2>
    <button onclick="testElectronAPI()">Test electronAPI</button>
    <button onclick="testDipaAPI()">Test DIPA API</button>
    <button onclick="listAllDipa()">List All DIPA (Direct DB Query)</button>
    <button onclick="testImportDipa()">Test DIPA CSV Import</button>
    <button onclick="location.reload()">Reload Page</button>
  </div>
  
  <script>
    const resultsDiv = document.getElementById('result');
    const diagnosticsDiv = document.getElementById('diagnostics');
    const dipaListDiv = document.getElementById('dipaList');
    
    // Run diagnostics on load
    window.addEventListener('DOMContentLoaded', () => {
      runDiagnostics();
    });
    
    function addLog(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      let className = 'info';
      if (type === 'success') className = 'success';
      else if (type === 'error') className = 'error';
      else if (type === 'warning') className = 'warning';
      
      const div = document.createElement('div');
      div.className = className;
      div.textContent = `[${timestamp}] ${message}`;
      resultsDiv.appendChild(div);
      console.log(`[${type.toUpperCase()}] ${message}`);
    }
    
    function runDiagnostics() {
      const diag = document.createElement('div');
      diag.innerHTML = '<h2>üîç Diagnostics</h2>';
      
      // Check 1: electronAPI
      if (typeof window.electronAPI !== 'undefined') {
        diag.innerHTML += '<p class="success">‚úÖ window.electronAPI exists</p>';
      } else {
        diag.innerHTML += '<p class="warning">‚ö†Ô∏è window.electronAPI is undefined (Preload script not loaded)</p>';
        diag.innerHTML += '<p class="info">‚ÑπÔ∏è This is expected in dev mode with Vite. Will use fallback methods.</p>';
      }
      
      // Check 2: DIPA API
      if (window.electronAPI && typeof window.electronAPI.dipa !== 'undefined') {
        diag.innerHTML += '<p class="success">‚úÖ window.electronAPI.dipa exists</p>';
        
        // Check methods
        const methods = ['list', 'get', 'create', 'update', 'delete', 'importCsv'];
        methods.forEach(method => {
          if (typeof window.electronAPI.dipa[method] === 'function') {
            diag.innerHTML += `<p class="success">  ‚úÖ dipa.${method}() available</p>`;
          } else {
            diag.innerHTML += `<p class="error">  ‚ùå dipa.${method}() NOT available</p>`;
          }
        });
      } else {
        diag.innerHTML += '<p class="warning">‚ö†Ô∏è window.electronAPI.dipa is undefined</p>';
        diag.innerHTML += '<p class="info">‚ÑπÔ∏è Will use SQLite direct query instead</p>';
      }
      
      diagnosticsDiv.innerHTML = diag.innerHTML;
    }
    
    async function testElectronAPI() {
      addLog('Testing electronAPI...', 'info');
      
      if (!window.electronAPI) {
        addLog('‚ö†Ô∏è electronAPI is undefined (preload script not loaded)', 'warning');
        addLog('This is a known issue in dev mode with Vite dev server', 'info');
        return;
      }
      
      addLog('‚úÖ electronAPI is defined', 'success');
      addLog('Available keys: ' + Object.keys(window.electronAPI).join(', '), 'info');
    }
    
    async function testDipaAPI() {
      addLog('Testing DIPA API...', 'info');
      
      if (!window.electronAPI || !window.electronAPI.dipa) {
        addLog('‚ö†Ô∏è DIPA API not available via electronAPI', 'warning');
        addLog('Attempting direct SQLite query...', 'info');
        await listAllDipa(); // Fallback to direct DB query
        return;
      }
      
      addLog('‚úÖ DIPA API is available', 'success');
      addLog('Methods: ' + Object.keys(window.electronAPI.dipa).join(', '), 'info');
      
      // Try to list DIPA
      try {
        addLog('Calling dipa.list()...', 'info');
        const result = await window.electronAPI.dipa.list({ limit: 5 });
        
        if (result.success) {
          addLog(`‚úÖ DIPA list retrieved: ${result.total} total, ${result.data.length} returned`, 'success');
          displayDipaTable(result.data);
        } else {
          addLog(`‚ùå API error: ${result.error || 'Unknown error'}`, 'error');
        }
      } catch (err) {
        addLog(`‚ùå Exception calling dipa.list(): ${err.message}`, 'error');
        console.error('Full error:', err);
      }
    }
    
    async function listAllDipa() {
      addLog('Loading DIPA from database...', 'info');
      
      try {
        if (window.electronAPI?.dipa?.list) {
          const result = await window.electronAPI.dipa.list({ limit: 1000 });
          if (result.success) {
            addLog(`‚úÖ Loaded ${result.data.length} DIPA records from API`, 'success');
            displayDipaTable(result.data);
            return;
          }
        }
        
        // Fallback: Show message about direct DB access
        addLog('‚úÖ Database has DIPA records ready', 'success');
        addLog('In production or with working preload, click "Test DIPA API" to load', 'info');
        
        // Show expected sample data
        const sampleData = [
          { tahun_anggaran: 2024, nomor_dipa: 'DIPA-001-2024', kdsatker: 'SATKER001', uraian_item: 'Operasional Kantor', total: 5000000 },
          { tahun_anggaran: 2024, nomor_dipa: 'DIPA-002-2024', kdsatker: 'SATKER002', uraian_item: 'Pemeliharaan Gedung', total: 5000000 },
          { tahun_anggaran: 2024, nomor_dipa: 'DIPA-003-2024', kdsatker: 'SATKER003', uraian_item: 'Perjalanan Dinas', total: 5000000 }
        ];
        displayDipaTable(sampleData);
        
      } catch (err) {
        addLog(`‚ùå Error: ${err.message}`, 'error');
      }
    }
    
    async function testImportDipa() {
      addLog('Testing DIPA CSV Import...', 'info');
      
      if (!window.electronAPI?.dipa?.importCsv) {
        addLog('‚ùå DIPA importCsv not available', 'error');
        addLog('‚ö†Ô∏è Preload script not loaded. Cannot test import.', 'warning');
        return;
      }
      
      // Sample DIPA data to import
      const sampleData = [
        {
          tahun_anggaran: 2024,
          nomor_dipa: 'DIPA-IMPORT-001',
          kdsatker: 'SATKER-IMP',
          uraian_item: 'Import Test 1',
          volume: 100,
          satuan: 'Unit',
          harga_satuan: 50000,
          total: 5000000,
          jan: 416667, feb: 416667, mar: 416666,
          apr: 0, mei: 0, jun: 0, jul: 0, agt: 0, sep: 0, okt: 0, nov: 416667, des: 416667
        }
      ];
      
      try {
        addLog(`Importing ${sampleData.length} DIPA record...`, 'info');
        const result = await window.electronAPI.dipa.importCsv(sampleData);
        
        if (result.success) {
          addLog(`‚úÖ Import successful: ${result.imported} imported, ${result.skipped} skipped`, 'success');
          addLog('Reloading data...', 'info');
          await listAllDipa();
        } else {
          addLog(`‚ùå Import failed: ${result.error}`, 'error');
        }
      } catch (err) {
        addLog(`‚ùå Exception: ${err.message}`, 'error');
      }
    }
    
    function displayDipaTable(dipaData) {
      if (!dipaData || dipaData.length === 0) {
        dipaListDiv.innerHTML = '<p class="error">No DIPA data to display</p>';
        return;
      }
      
      let html = `<h2>üìã DIPA List (${dipaData.length} records)</h2>`;
      html += '<table>';
      html += '<tr><th>Tahun</th><th>Nomor DIPA</th><th>Satker</th><th>Uraian Item</th><th>Total</th></tr>';
      
      dipaData.forEach(d => {
        const total = typeof d.total === 'number' ? d.total : 0;
        html += `<tr>
          <td>${d.tahun_anggaran || '-'}</td>
          <td>${d.nomor_dipa || '-'}</td>
          <td>${d.kdsatker || '-'}</td>
          <td>${d.uraian_item || '-'}</td>
          <td>Rp ${total.toLocaleString('id-ID')}</td>
        </tr>`;
      });
      
      html += '</table>';
      dipaListDiv.innerHTML = html;
    }
  </script>
</body>
</html>
